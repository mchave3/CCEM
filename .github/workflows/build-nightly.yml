name: Build Nightly Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

env:
  SOURCE_BRANCH: develop

permissions:
  contents: write

jobs:
  check_changes:
    name: "🧐 Check Pending Changes"
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      latest_tag: ${{ steps.detect.outputs.latest_tag }}
      branch: ${{ steps.detect.outputs.branch }}
    steps:
      - name: "🛎️ Checkout Develop Branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_BRANCH }}
          fetch-depth: 0
          fetch-tags: true

      - name: "🔍 Detect Changes Since Last Nightly"
        id: detect
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "🌙 Nightly guard evaluating branch: $($env:SOURCE_BRANCH)"

          $latestTag = git tag --list 'v????-*' --sort=-creatordate | Select-Object -First 1
          if ([string]::IsNullOrWhiteSpace($latestTag)) {
            Write-Host "⚠️ No nightly tags found with pattern v????-*"
          } else {
            Write-Host "🕑 Latest nightly tag discovered: $latestTag"
          }

          if ([string]::IsNullOrWhiteSpace($latestTag)) {
            $hasChanges = 'true'
            Write-Host "🚨 No previous nightly tag found. Forcing build."
          } else {
            git diff --quiet $latestTag HEAD
            if ($LASTEXITCODE -eq 0) {
              $hasChanges = 'false'
              Write-Host "✅ No changes detected on develop since $latestTag."
            } else {
              $hasChanges = 'true'
              Write-Host "🔥 Changes detected on develop since $latestTag."
            }
          }

          "has_changes=$hasChanges" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "latest_tag=$latestTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "branch=$($env:SOURCE_BRANCH)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "📤 Outputs emitted -> has_changes=$hasChanges, latest_tag=$latestTag, branch=$($env:SOURCE_BRANCH)"

          if ($hasChanges -ne 'true') {
            if ([string]::IsNullOrWhiteSpace($latestTag)) {
              $reason = "no new commits on '$($env:SOURCE_BRANCH)' since the previous nightly run."
            } else {
              $reason = "no new commits on '$($env:SOURCE_BRANCH)' since $latestTag."
            }

            $summaryLines = @(
              '### Nightly build skipped'
              ''
              "- Reason: $reason"
            )
            $summaryLines | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            Write-Host "🛑 Nightly build skipped: $reason"
          } else {
            Write-Host "🚀 Nightly build will proceed."
          }

  derive_version:
    name: "🧮 Derive Nightly Version"
    needs: check_changes
    if: ${{ needs.check_changes.outputs.has_changes == 'true' }}
    uses: ./.github/workflows/versioning.yml
    with:
      release_type: nightly

  build_and_publish:
    name: "📦 Build and Publish Nightly"
    needs:
      - check_changes
      - derive_version
    if: ${{ needs.check_changes.outputs.has_changes == 'true' }}
    uses: ./.github/workflows/build-and-publish.yml
    with:
      branch: ${{ needs.check_changes.outputs.branch }}
      version: ${{ needs.derive_version.outputs.version }}
      msix_version: ${{ needs.derive_version.outputs.msix_version }}
      tag: ${{ needs.derive_version.outputs.tag }}
      channel: ${{ needs.derive_version.outputs.channel }}
      prerelease: true
      release_name: ${{ needs.derive_version.outputs.release_name }}
      make_latest: "false"
    secrets:
      release_token: ${{ secrets.GITHUB_TOKEN }}
